<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€²å­¦å˜èª 1-48 æœ€çµ‚è©¦é¨“</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --accent-color: #4a90e2;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--primary-bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 15px; }
        .container { width: 100%; max-width: 500px; background: var(--glass-bg); border-radius: 20px; padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        
        .header-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color: #555; }
        .progress-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--success-color); width: 0%; transition: width 0.3s; }

        .question-box { background: #f8f9fa; padding: 40px 15px; border-radius: 15px; text-align: center; margin-bottom: 25px; border: 1px solid #ddd; display: flex; flex-direction: column; justify-content: center; min-height: 200px; }
        .q-en { font-size: 1.6rem; font-weight: bold; color: #333; margin-bottom: 15px; line-height: 1.2; }
        .q-np { font-size: 1.4rem; color: #4a90e2; font-weight: 500; line-height: 1.2; }

        .input-area { text-align: center; margin-bottom: 20px; }
        .answer-input { width: 100%; padding: 15px; font-size: 1.5rem; border: 3px solid #ddd; border-radius: 12px; text-align: center; outline: none; transition: border-color 0.2s; }
        .answer-input:focus { border-color: var(--accent-color); }
        .answer-input.correct-anim { border-color: var(--success-color); background-color: #eaffef; }
        .answer-input.wrong-anim { border-color: var(--danger-color); background-color: #fff0f0; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; }
        input[type="text"], select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        
        .btn-main { display: block; width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--accent-color); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 15px; transition: opacity 0.2s; }
        .btn-main:active { opacity: 0.8; }
        .btn-link { background: #34495e; }
        .btn-outline { background: #95a5a6; }

        .mistake-section { margin-top: 25px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .mistake-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background: #eee; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
        .tab-btn.active[data-level="3"] { background: var(--danger-color); color: white; }
        .tab-btn.active[data-level="2"] { background: var(--warning-color); color: white; }
        .tab-btn.active[data-level="1"] { background: var(--accent-color); color: white; }
        .mistake-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 180px; overflow-y: auto; padding: 5px; }
        .mistake-item { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 0.85rem; text-align: center; cursor: help; }

        .result-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .score-big { font-size: 3.5rem; text-align: center; color: var(--accent-color); font-weight: bold; margin: 10px 0; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; color: white; margin-right: 8px; font-size: 0.75rem; }
        .tag-correct { background: var(--success-color); }
        .tag-wrong { background: var(--danger-color); }

        #cheat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; text-align: center; padding: 20px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="setup-screen" class="container">
        <h2 style="text-align:center; margin-top:0;">é€²å­¦å˜èª 1-48 æœ€çµ‚è©¦é¨“</h2>
        <div style="text-align: center; font-size: 0.85rem; color: #666; margin-bottom: 15px;">Answer in Hiragana (18 Questions)</div>
        <div class="form-group">
            <label>æ°å (Name)</label>
            <input type="text" id="user-name" placeholder="Enter your name" autocomplete="off">
        </div>
        <div class="form-group">
            <label>å­¦ç±ç•ªå· (Student ID)</label>
            <input type="text" id="student-id" placeholder="Ex: S580" autocomplete="off">
        </div>
        <div class="form-group">
            <label>ã‚¯ãƒ©ã‚¹ (Class)</label>
            <select id="class-name">
                <option value="SP12">SP12</option>
                <option value="SP13">SP13</option>
            </select>
        </div>
        <button class="btn-main" onclick="startQuiz()">è©¦é¨“é–‹å§‹ (Start Exam)</button>
        <a href="https://docs.google.com/spreadsheets/d/1IKGHssYa7BrylPNglti1iNQ4T69UR7TB_bVSNzC1zyQ/edit#gid=1457252475" target="_blank" class="btn-main btn-link">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>

        <div class="mistake-section">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px;">ğŸ“– å¼±ç‚¹å…‹æœ (Mistake List)</div>
            <div class="mistake-tabs">
                <button class="tab-btn active" data-level="3" onclick="switchMistakeTab(3)">ğŸ”¥ 3+</button>
                <button class="tab-btn" data-level="2" onclick="switchMistakeTab(2)">âš ï¸ 2</button>
                <button class="tab-btn" data-level="1" onclick="switchMistakeTab(1)">ğŸ“– 1</button>
            </div>
            <div id="mistake-list" class="mistake-list"></div>
            <button class="btn-main btn-outline" onclick="clearHistory()" style="font-size:0.75rem; padding:8px; margin-top:10px;">è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="quiz-screen" class="container hidden">
        <div class="header-info">
            <span id="current-q-num">Q 1 / 18</span>
            <span id="live-score">æ­£è§£: 0</span>
        </div>
        <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="question-box">
            <div id="q-en" class="q-en"></div>
            <div id="q-np" class="q-np"></div>
        </div>
        <div class="input-area">
            <input type="text" id="answer-input" class="answer-input" placeholder="ã²ã‚‰ãŒãªã‚’å…¥åŠ›" autocomplete="off">
            <button class="btn-main" id="submit-btn" onclick="checkAnswer()">ç¢ºå®š (Enter)</button>
        </div>
        <div style="text-align: center; color: #888; font-size: 0.8rem;">â€»å¹³ä»®åã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>

    <div id="result-screen" class="container hidden" style="max-height: 90vh; overflow-y: auto;">
        <h2 style="text-align:center">è©¦é¨“çµæœ</h2>
        <div class="score-big" id="final-score">0 / 18</div>
        <div id="analysis-area"></div>
        <button class="btn-main" onclick="location.reload()">ã‚‚ã†ä¸€åº¦å—é¨“</button>
        <a href="https://docs.google.com/spreadsheets/d/1IKGHssYa7BrylPNglti1iNQ4T69UR7TB_bVSNzC1zyQ/edit#gid=1457252475" target="_blank" class="btn-main btn-link">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç¢ºèª</a>
    </div>

    <div id="cheat-overlay" class="hidden">
        <h1 style="font-size: 4rem; color: var(--danger-color);">å¤±æ ¼</h1>
        <p>ç”»é¢åˆ‡ã‚Šæ›¿ãˆãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€‚<br>è©¦é¨“ã¯ç„¡åŠ¹ã§ã™ã€‚</p>
        <button class="btn-main" style="width:200px" onclick="location.reload()">æˆ»ã‚‹</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxViOSf-S2fNbseM9FivlqIUw_Gg2TSYkrzo-N1eOUVtpFPgrHRl3rmY3zHGTfTqSSY/exec";
        
        const rawData = [
            ["å‹Ÿé›†è¦é …", "ã¼ã—ã‚…ã†ã‚ˆã†ã“ã†", "Application Guidelines", "à¤­à¤°à¥à¤¨à¤¾ à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶à¤¿à¤•à¤¾"],
            ["å…¥å­¦é¡˜æ›¸", "ã«ã‚…ã†ãŒããŒã‚“ã—ã‚‡", "Application Form", "à¤­à¤°à¥à¤¨à¤¾ à¤«à¤¾à¤°à¤®"],
            ["èª¿æŸ»æ›¸", "ã¡ã‚‡ã†ã•ã—ã‚‡", "School Report / Survey", "à¤µà¤¿à¤¦à¥à¤¯à¤¾à¤²à¤¯ à¤ªà¥à¤°à¤¤à¤¿à¤µà¥‡à¤¦à¤¨"],
            ["å±¥æ­´æ›¸", "ã‚Šã‚Œãã—ã‚‡", "Resume / CV", "à¤¬à¤¾à¤¯à¥‹à¤¡à¤¾à¤Ÿà¤¾ (CV)"],
            ["çµŒè²»æ”¯å¼æ›¸", "ã‘ã„ã²ã—ã¹ã‚“ã—ã‚‡", "Statement of Financial Support", "à¤†à¤°à¥à¤¥à¤¿à¤• à¤¸à¤¹à¤¯à¥‹à¤—à¤•à¥‹ à¤µà¤¿à¤µà¤°à¤£"],
            ["å¿—æœ›ç†ç”±ã‚·ãƒ¼ãƒˆ", "ã—ã¼ã†ã‚Šã‚†ã†ã—ãƒ¼ã¨", "Statement of Purpose Sheet", "à¤…à¤§à¥à¤¯à¤¯à¤¨à¤•à¥‹ à¤‰à¤¦à¥à¤¦à¥‡à¤¶à¥à¤¯ à¤ªà¤¤à¥à¤°"],
            ["å­¦æ ¡é•·æ¨è–¦æ›¸", "ãŒã£ã“ã†ã¡ã‚‡ã†ã™ã„ã›ã‚“ã—ã‚‡", "Principal's Recommendation Letter", "à¤ªà¥à¤°à¤§à¤¾à¤¨à¤¾à¤§à¥à¤¯à¤¾à¤ªà¤•à¤•à¥‹ à¤¸à¤¿à¤«à¤¾à¤°à¤¿à¤¸ à¤ªà¤¤à¥à¤°"],
            ["å’æ¥­è¨¼æ˜æ›¸", "ãã¤ãã‚‡ã†ã—ã‚‡ã†ã‚ã„ã—ã‚‡", "Graduation Certificate", "à¤¸à¥à¤¨à¤¾à¤¤à¤• à¤ªà¥à¤°à¤®à¤¾à¤£à¤ªà¤¤à¥à¤°"],
            ["å’æ¥­è¨¼æ›¸", "ãã¤ãã‚‡ã†ã—ã‚‡ã†ã—ã‚‡", "Diploma / Certificate of Graduation", "à¤¶à¥ˆà¤•à¥à¤·à¤¿à¤• à¤ªà¥à¤°à¤®à¤¾à¤£à¤ªà¤¤à¥à¤° (Diploma)"],
            ["æˆç¸¾è¨¼æ˜æ›¸", "ã›ã„ã›ãã—ã‚‡ã†ã‚ã„ã—ã‚‡", "Academic Transcript", "à¤²à¤¬à¥à¤§à¤¾à¤‚à¤• à¤ªà¤¤à¥à¤° (Transcript)"],
            ["ä¿®äº†è¨¼æ˜æ›¸", "ã—ã‚…ã†ã‚Šã‚‡ã†ã—ã‚‡ã†ã‚ã„ã—ã‚‡", "Certificate of Completion", "à¤ªà¥‚à¤°à¤¾ à¤—à¤°à¥‡à¤•à¥‹ à¤ªà¥à¤°à¤®à¤¾à¤£à¤ªà¤¤à¥à¤°"],
            ["åœ¨ç±è¨¼æ˜æ›¸", "ã–ã„ã›ãã—ã‚‡ã†ã‚ã„ã—ã‚‡", "Certificate of Enrollment", "à¤­à¤°à¥à¤¨à¤¾ à¤ªà¥à¤°à¤®à¤¾à¤£à¤ªà¤¤à¥à¤°"],
            ["æ—¥æœ¬èªèƒ½åŠ›è©¦é¨“æˆç¸¾é€šçŸ¥æ›¸", "ã«ã»ã‚“ã”ã®ã†ã‚Šã‚‡ãã—ã‘ã‚“ã›ã„ã›ãã¤ã†ã¡ã—ã‚‡", "JLPT Score Report", "JLPT à¤¨à¤¤à¤¿à¤œà¤¾ à¤ªà¤¤à¥à¤°"],
            ["æ—¥æœ¬ç•™å­¦è©¦é¨“æˆç¸¾ç¢ºèªæ›¸", "ã«ã»ã‚“ã‚Šã‚…ã†ãŒãã—ã‘ã‚“ã›ã„ã›ãã‹ãã«ã‚“ã—ã‚‡", "EJU Score Confirmation", "EJU à¤¨à¤¤à¤¿à¤œà¤¾ à¤ªà¥à¤·à¥à¤Ÿà¤¿à¤•à¤°à¤£"],
            ["åœ¨ç•™ã‚«ãƒ¼ãƒ‰", "ã–ã„ã‚Šã‚…ã†ã‹ãƒ¼ã©", "Residence Card", "à¤†à¤µà¤¾à¤¸à¥€à¤¯ à¤•à¤¾à¤°à¥à¤¡"],
            ["ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ", "ã±ã™ã½ãƒ¼ã¨", "Passport", "à¤°à¤¾à¤¹à¤¦à¤¾à¤¨à¥€"],
            ["å—é¨“ç¥¨", "ã˜ã‚…ã‘ã‚“ã²ã‚‡ã†", "Examination Voucher", "à¤ªà¤°à¥€à¤•à¥à¤·à¤¾ à¤ªà¥à¤°à¤µà¥‡à¤¶ à¤ªà¤¤à¥à¤°"],
            ["å‡ºé¡˜", "ã—ã‚…ã¤ãŒã‚“", "Application (Submission)", "à¤†à¤µà¥‡à¤¦à¤¨"],
            ["å‡ºé¡˜è³‡æ ¼", "ã—ã‚…ã¤ãŒã‚“ã—ã‹ã", "Application Eligibility", "à¤†à¤µà¥‡à¤¦à¤¨ à¤¯à¥‹à¤—à¥à¤¯à¤¤à¤¾"],
            ["é¡˜æ›¸å—ä»˜æœŸé–“", "ãŒã‚“ã—ã‚‡ã€€ã†ã‘ã¤ã‘ãã‹ã‚“", "Application Period", "à¤†à¤µà¥‡à¤¦à¤¨ à¤¸à¥à¤µà¥€à¤•à¤¾à¤° à¤—à¤°à¥à¤¨à¥‡ à¤…à¤µà¤§à¤¿"],
            ["ç· åˆ‡", "ã—ã‚ãã‚Š", "Deadline", "à¤…à¤¨à¥à¤¤à¤¿à¤® à¤®à¥à¤¯à¤¾à¤¦"],
            ["å¿…ç€", "ã²ã£ã¡ã‚ƒã", "Must Arrive By", "à¤…à¤¨à¤¿à¤µà¤¾à¤°à¥à¤¯ à¤ªà¥à¤—à¥à¤¨à¥à¤ªà¤°à¥à¤¨à¥‡"],
            ["æŒå‚", "ã˜ã•ã‚“", "Bring in person", "à¤†à¤«à¥ˆ à¤‰à¤ªà¤¸à¥à¤¥à¤¿à¤¤ à¤­à¤à¤° à¤¬à¥à¤à¤¾à¤‰à¤¨à¥‡"],
            ["éƒµé€", "ã‚†ã†ãã†", "Mail / Post", "à¤¹à¥à¤²à¤¾à¤• à¤®à¤¾à¤°à¥à¤«à¤¤"],
            ["æ›¸ç•™éƒµä¾¿", "ã‹ãã¨ã‚ã‚†ã†ã³ã‚“", "Registered Mail", "à¤°à¤œà¤¿à¤¸à¥à¤Ÿà¥à¤°à¥€ à¤¹à¥à¤²à¤¾à¤•"],
            ["è¨˜å…¥", "ãã«ã‚…ã†", "Entry / Filling out", "à¤­à¤°à¥à¤¨à¥"],
            ["è²¼ä»˜", "ã¡ã‚‡ã†ãµ", "Affixing / Pasting", "à¤Ÿà¤¾à¤à¤¸à¥à¤¨à¥"],
            ["å—ç†", "ã˜ã‚…ã‚Š", "Acceptance (of documents)", "à¤¸à¥à¤µà¥€à¤•à¤¾à¤°"],
            ["è¿”å´", "ã¸ã‚“ãã‚ƒã", "Return (of documents)", "à¤«à¤¿à¤°à¥à¤¤à¤¾"],
            ["é¸æŠœ", "ã›ã‚“ã°ã¤", "Selection / Screening", "à¤›à¤¨à¥‹à¤Ÿ"],
            ["é¸æŠœæ–¹æ³•", "ã›ã‚“ã°ã¤ã»ã†ã»ã†", "Selection Method", "à¤›à¤¨à¥‹à¤Ÿ à¤µà¤¿à¤§à¤¿"],
            ["é¸æŠœæ—¥ç¨‹", "ã›ã‚“ã°ã¤ã«ã£ã¦ã„", "Selection Schedule", "à¤›à¤¨à¥‹à¤Ÿ à¤¤à¤¾à¤²à¤¿à¤•à¤¾"],
            ["å—é¨“", "ã˜ã‚…ã‘ã‚“", "Taking an exam", "à¤ªà¤°à¥€à¤•à¥à¤·à¤¾ à¤¦à¤¿à¤¨à¥"],
            ["å†å—é¨“", "ã•ã„ã˜ã‚…ã‘ã‚“", "Retaking an exam", "à¤ªà¥à¤¨à¤ƒ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾ à¤¦à¤¿à¤¨à¥"],
            ["é¢æ¥è©¦é¨“", "ã‚ã‚“ã›ã¤ã—ã‘ã‚“", "Interview Test", "à¤…à¤¨à¥à¤¤à¤°à¥à¤µà¤¾à¤°à¥à¤¤à¤¾ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾"],
            ["ç§‘ç›®è©¦é¨“", "ã‹ã‚‚ãã—ã‘ã‚“", "Subject Exam", "à¤µà¤¿à¤·à¤¯à¤—à¤¤ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾"],
            ["ç­†è¨˜è©¦é¨“", "ã²ã£ãã—ã‘ã‚“", "Written Exam", "à¤²à¤¿à¤–à¤¿à¤¤ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾"],
            ["ä½œæ–‡", "ã•ãã¶ã‚“", "Essay / Composition", "à¤¨à¤¿à¤¬à¤¨à¥à¤§"],
            ["æ¥æ ¡å…¥è©¦", "ã‚‰ã„ã“ã†ã«ã‚…ã†ã—", "On-campus Exam", "à¤•à¥à¤¯à¤¾à¤®à¥à¤ªà¤¸ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾"],
            ["ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…¥è©¦", "ãŠã‚“ã‚‰ã„ã‚“ã«ã‚…ã†ã—", "Online Exam", "à¤…à¤¨à¤²à¤¾à¤‡à¤¨ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾"],
            ["åˆæ ¼", "ã”ã†ã‹ã", "Pass / Success", "à¤‰à¤¤à¥à¤¤à¥€à¤°à¥à¤£"],
            ["ä¸åˆæ ¼", "ãµã”ã†ã‹ã", "Fail / Rejection", "à¤…à¤¨à¥à¤¤à¥à¤¤à¥€à¤°à¥à¤£"],
            ["åˆå¦ç™ºè¡¨", "ã”ã†ã²ã¯ã£ã´ã‚‡ã†", "Announcement of Results", "à¤¨à¤¤à¤¿à¤œà¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶à¤¨"],
            ["å®šå“¡", "ã¦ã„ã„ã‚“", "Quota / Capacity", "à¤•à¥‹à¤Ÿà¤¾ (à¤¸à¤¿à¤Ÿ à¤¸à¤‚à¤–à¥à¤¯à¤¾)"],
            ["ä½µé¡˜", "ã¸ã„ãŒã‚“", "Multiple Applications", "à¤¬à¤¹à¥ à¤†à¤µà¥‡à¤¦à¤¨"],
            ["å°‚é¡˜", "ã›ã‚“ãŒã‚“", "First Choice (Single Application)", "à¤ªà¤¹à¤¿à¤²à¥‹ à¤°à¥‹à¤œà¤¾à¤ˆ (à¤à¤•à¤² à¤†à¤µà¥‡à¤¦à¤¨)"],
            ["å…¥å­¦é¸æŠœæ–™", "ã«ã‚…ã†ãŒãã›ã‚“ã°ã¤ã‚Šã‚‡ã†", "Entrance Screening Fee", "à¤ªà¥à¤°à¤µà¥‡à¤¶ à¤›à¤¨à¥‹à¤Ÿ à¤¶à¥à¤²à¥à¤•"],
            ["å—é¨“æ–™", "ã˜ã‚…ã‘ã‚“ã‚Šã‚‡ã†", "Examination Fee", "à¤ªà¤°à¥€à¤•à¥à¤·à¤¾ à¤¶à¥à¤²à¥à¤•"]
        ];

        let quizData = [];
        let currentIdx = 0;
        let score = 0;
        let quizActive = false;
        let userRecords = [];
        let historyData = JSON.parse(localStorage.getItem('vocab_miss_v3') || '{}');

        window.onload = () => switchMistakeTab(3);

        function startQuiz() {
            const name = document.getElementById('user-name').value.trim();
            const sid = document.getElementById('student-id').value.trim();
            if(!name || !sid) return alert("æ°åã¨å­¦ç±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            // Logic: 9 from index 36-47 (Q37-48) + 9 from others
            const groupA = rawData.slice(36, 48).sort(() => Math.random() - 0.5).slice(0, 9);
            const others = rawData.slice(0, 36).concat(rawData.slice(48)).sort(() => Math.random() - 0.5).slice(0, 9);
            quizData = groupA.concat(others).sort(() => Math.random() - 0.5);

            currentIdx = 0; score = 0; userRecords = []; quizActive = true;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = quizData[currentIdx];
            document.getElementById('q-en').innerText = q[2];
            document.getElementById('q-np').innerText = q[3];
            document.getElementById('current-q-num').innerText = `Q ${currentIdx + 1} / 18`;
            document.getElementById('progress-bar').style.width = (currentIdx / 18 * 100) + "%";
            
            const input = document.getElementById('answer-input');
            input.value = '';
            input.className = 'answer-input';
            input.disabled = false;
            input.focus();
        }

        function checkAnswer() {
            const inputField = document.getElementById('answer-input');
            const userAns = inputField.value.trim().replace(/\s+/g, '');
            const correctAns = quizData[currentIdx][1].replace(/\s+/g, '');
            const isCorrect = (userAns === correctAns);

            if (inputField.disabled) return;
            inputField.disabled = true;

            if (isCorrect) {
                inputField.classList.add('correct-anim');
                score++;
                document.getElementById('live-score').innerText = `æ­£è§£: ${score}`;
            } else {
                inputField.classList.add('wrong-anim');
                // Store mistake by Kanji even though not shown on screen
                historyData[quizData[currentIdx][0]] = (historyData[quizData[currentIdx][0]] || 0) + 1;
                localStorage.setItem('vocab_miss_v3', JSON.stringify(historyData));
            }

            userRecords.push({
                kanji: quizData[currentIdx][0],
                ans: quizData[currentIdx][1],
                user: userAns || "(None)",
                isOk: isCorrect
            });

            setTimeout(() => {
                currentIdx++;
                if(currentIdx < 18) renderQuestion();
                else finish();
            }, 500);
        }

        document.getElementById('answer-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAnswer();
        });

        async function finish() {
            quizActive = false;
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score} / 18`;

            const analysis = document.getElementById('analysis-area');
            analysis.innerHTML = '';
            userRecords.forEach(r => {
                const d = document.createElement('div');
                d.className = 'result-item';
                d.innerHTML = `<span class="tag ${r.isOk?'tag-correct':'tag-wrong'}">${r.isOk?'â—‹':'Ã—'}</span> <strong>${r.kanji}</strong><br><small>Answer: ${r.ans} / Input: ${r.user}</small>`;
                analysis.appendChild(d);
            });

            const payload = {
                timestamp: new Date().toLocaleString('ja-JP'),
                studentId: document.getElementById('student-id').value,
                name: document.getElementById('user-name').value,
                className: document.getElementById('class-name').value,
                score: score + " / 18"
            };
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }

        function switchMistakeTab(level) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-level="${level}"]`).classList.add('active');
            const listArea = document.getElementById('mistake-list');
            listArea.innerHTML = '';
            
            const filtered = Object.keys(historyData).filter(word => {
                const count = historyData[word];
                return level === 3 ? count >= 3 : count === level;
            });

            if (filtered.length === 0) {
                listArea.innerHTML = '<div style="grid-column:1/-1; color:#999; text-align:center; font-size:0.75rem; margin-top:10px;">No data</div>';
                return;
            }

            filtered.forEach(word => {
                const item = document.createElement('div');
                item.className = 'mistake-item';
                item.innerText = word;
                item.onclick = () => {
                    const pair = rawData.find(p => p[0] === word);
                    alert(`Word: ${word}\nReading: ${pair[1]}\nMeaning: ${pair[2]}`);
                };
                listArea.appendChild(item);
            });
        }

        function clearHistory() {
            if(confirm("Reset mistake history?")) {
                localStorage.removeItem('vocab_miss_v3');
                historyData = {};
                switchMistakeTab(3);
            }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && quizActive) {
                quizActive = false;
                document.getElementById('cheat-overlay').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>